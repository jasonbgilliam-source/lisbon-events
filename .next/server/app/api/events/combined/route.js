"use strict";(()=>{var e={};e.id=528,e.ids=[528],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},161:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>C,requestAsyncStorage:()=>v,routeModule:()=>S,serverHooks:()=>E,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{GET:()=>h,dynamic:()=>_,revalidate:()=>p});var a=r(9303),i=r(8716),s=r(3131),o=r(474),l=r(3292),u=r(1017),c=r.n(u);let _="force-dynamic",p=0;function d(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}async function g(){let{data:e,error:t}=await (0,o.R)().from("category_catalog").select("name");if(t)throw Error(t.message);let r=(e||[]).map(e=>String(e.name)),n=new Map;for(let e of r)n.set(e.trim().toLowerCase(),e);return{list:r,canon:n}}function m(e,t){let r=(e??"").toString().trim();return r?t.get(r.toLowerCase())??null:null}async function f(e,t,r,n,a,i){let s=(0,o.R)().from("events").select("id,title,description,starts_at,ends_at,category,location_name,city,address,ticket_url,image_url,created_at,all_day,age,organizer_email,youtube_url,spotify_url").gte("starts_at",e).lte("starts_at",t);n&&(s=s.eq("city",n)),a&&(s=s.or('age.is.null,age.eq."All ages",age.eq."all ages",age.eq."All Ages"')),r&&(s=s.eq("category",r));let{data:l,error:u}=await s;if(u)throw Error(u.message);return(l||[]).map(e=>{let t=i?m(e.category,i):e.category??null;return{id:String(e.id),title:e.title,description:e.description??null,starts_at:d(e.starts_at),ends_at:d(e.ends_at),category:t,location_name:e.location_name??null,city:e.city??null,address:e.address??null,ticket_url:e.ticket_url??null,image_url:e.image_url??null,created_at:d(e.created_at),all_day:e.all_day??null,age:e.age??null,organizer_email:e.organizer_email??null,youtube_url:e.youtube_url??null,spotify_url:e.spotify_url??null,source:"db"}})}async function y(e,t,r,n,a,i,s){let o=[];try{let t=await (0,l.readFile)(e,"utf8");o=function(e){let t=[],r=0,n="",a=[],i=!1;for(;r<e.length;){let s=e[r];if(i){if('"'===s){if('"'===e[r+1]){n+='"',r+=2;continue}i=!1,r++;continue}n+=s,r++;continue}if('"'===s){i=!0,r++;continue}if(","===s){a.push(n),n="",r++;continue}if("\r"===s){r++;continue}if("\n"===s){a.push(n),t.push(a),a=[],n="",r++;continue}n+=s,r++}return a.push(n),t.push(a),t.filter(e=>e.some(e=>""!==e))}(t)}catch{return[]}if(o.length<2)return[];let u=o[0].map(e=>e.trim().toLowerCase()),c=e=>u.indexOf(e),_=[];for(let e=1;e<o.length;e++){let l=o[e],u=l[c("title")]||l[c("name")]||l[c("event_title")]||"",p=d(l[c("starts_at")]||l[c("start")]||l[c("start_time")]||l[c("start_datetime")]);if(!u||!p)continue;let g=d(l[c("ends_at")]||l[c("end")]||l[c("end_time")]||l[c("end_datetime")]),f=l[c("category")]||l[c("type")]||"",y=s?m(f,s):f||null,h=(l[c("city")]||"").trim()||null;if(a&&h!==a||n&&y!==n)continue;let S=new Date(p).getTime();if(S<new Date(t).getTime()||S>new Date(r).getTime())continue;let v=function(e){if(!0===e||!1===e)return e;if(null==e)return!1;let t=String(e).trim().toLowerCase();return"true"===t||"1"===t||"yes"===t}(l[c("all_day")]||l[c("is_all_day")]),w=l[c("age")]||null;(!i||!w||/^all ages$/i.test(w))&&_.push({id:`csv-${e}`,title:u,description:l[c("description")]||l[c("details")]||null,starts_at:p,ends_at:g,category:y,location_name:l[c("location_name")]||l[c("venue")]||l[c("location")]||null,city:h,address:l[c("address")]||null,ticket_url:l[c("ticket_url")]||l[c("source_url")]||l[c("url")]||null,image_url:l[c("image_url")]||null,created_at:null,all_day:v,age:w,organizer_email:l[c("organizer_email")]||l[c("organizer")]||null,youtube_url:l[c("youtube_url")]||null,spotify_url:l[c("spotify_url")]||null,source:"csv"})}return _}async function h(e){try{let t=new URL(e.url),r=t.searchParams.get("from"),n=t.searchParams.get("to"),a=(t.searchParams.get("category")||"").trim()||null,i=(t.searchParams.get("city")||"").trim()||null,s="true"===(t.searchParams.get("all_ages")||"").toLowerCase();if(!r||!n)return new Response(JSON.stringify({error:"Missing from/to"}),{status:400,headers:{"Content-Type":"application/json"}});let{list:o,canon:l}=await g(),u=a?l.get(a.toLowerCase())??"__INVALID__":null;if("__INVALID__"===u)return new Response(JSON.stringify({items:[]}),{headers:{"Content-Type":"application/json","Cache-Control":"no-store"}});let _=await f(r,n,u??void 0,i??void 0,s,l),p=c().join(process.cwd(),"public","events.csv"),d=await y(p,r,n,u??void 0,i??void 0,s,l),m=[..._,...d].sort((e,t)=>new Date(e.starts_at).getTime()-new Date(t.starts_at).getTime());return new Response(JSON.stringify({items:m,catalog:o}),{headers:{"Content-Type":"application/json","Cache-Control":"no-store"}})}catch(e){return new Response(JSON.stringify({error:e?.message||"failed"}),{status:500,headers:{"Content-Type":"application/json"}})}}let S=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/events/combined/route",pathname:"/api/events/combined",filename:"route",bundlePath:"app/api/events/combined/route"},resolvedPagePath:"/workspaces/lisbon-events/app/api/events/combined/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:v,staticGenerationAsyncStorage:w,serverHooks:E}=S,A="/api/events/combined/route";function C(){return(0,s.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:w})}},474:(e,t,r)=>{r.d(t,{R:()=>a});var n=r(1657);function a(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL||process.env.SUPABASE_URL||"",t=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"";if(!e||!t)throw Error("Supabase URL or KEY missing. Set NEXT_PUBLIC_SUPABASE_URL and either SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY.");return(0,n.eI)(e,t,{auth:{persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,561],()=>r(161));module.exports=n})();